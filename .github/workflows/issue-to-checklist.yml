name: AI Issue Triage (Gemini)

on:
  issues:
    types: [opened]

permissions:
  issues: write

jobs:
  analyze_issue:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install dependencies
        run: pip install requests google-genai

      - name: Analyze Issue with Gemini Pro
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ISSUE_TITLE: ${{ github.event.issue.title }}
          ISSUE_BODY: ${{ github.event.issue.body }}
          REPO_FULL_NAME: ${{ github.repository }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
        run: |
          python -c "
          import os
          import requests
          import json

          # Prefer a stable flash model for v1beta; gemini-2.5 is the target
          PREFERRED_MODEL = "models/gemini-2.5-flash"

          # 1. Setup Data
          api_key = os.environ.get('GEMINI_API_KEY')
          issue_title = os.environ.get('ISSUE_TITLE')
          issue_body = os.environ.get('ISSUE_BODY')
          repo = os.environ.get('REPO_FULL_NAME')
          issue_number = os.environ.get('ISSUE_NUMBER')
          gh_token = os.environ.get('GITHUB_TOKEN')

          # 2. Discover a supported model for v1beta; prefer 2.5 flash, fall back to pro
          list_url = f'https://generativelanguage.googleapis.com/v1beta/models?key={api_key}'
          model_name = PREFERRED_MODEL
          try:
              list_resp = requests.get(list_url, timeout=10)
              list_resp.raise_for_status()
              models = list_resp.json().get('models', [])

              # Filter models that support generateContent
              def supports_generate(model):
                  methods = model.get('supportedGenerationMethods', []) or []
                  return any('generateContent' in m for m in methods)

              names = [m.get('name') for m in models if m.get('name') and supports_generate(m)]

              # Prefer any 2.5 flash, then any flash, else pro
              flash_25 = [n for n in names if 'gemini-2.5-flash' in n]
              flash_any = [n for n in names if 'flash' in n]
              pro_any = [n for n in names if 'pro' in n]

              if flash_25:
                  model_name = flash_25[0]
              elif flash_any:
                  model_name = flash_any[0]
              elif pro_any:
                  model_name = pro_any[0]
              else:
                  model_name = names[0] if names else PREFERRED_MODEL
          except Exception as e:
              print(f'Warning: could not list models, defaulting to {PREFERRED_MODEL}. Error: {e}')

          url = f'https://generativelanguage.googleapis.com/v1beta/{model_name}:generateContent?key={api_key}'
          
          system_instruction = 'You are a senior technical project manager. Read the issue description and convert it into a clear, actionable Markdown checklist. Do not include introductory text, just the checklist.'
          user_content = f'Title: {issue_title}\n\nDescription:\n{issue_body}'

          payload = {
              'contents': [{
                  'parts': [{'text': system_instruction + '\n\n' + user_content}]
              }]
          }

          # 3. Call Google Gemini API
          headers = {'Content-Type': 'application/json'}
          
          print(f'Sending request to Gemini with model: {model_name} ...')
          response = requests.post(url, headers=headers, json=payload)
          
          if response.status_code != 200:
              print(f'Error: {response.text}')
              exit(1)
              
          # Extract text from Gemini response structure
          result = response.json()
          try:
              ai_checklist = result['candidates'][0]['content']['parts'][0]['text']
          except (KeyError, IndexError):
              print('Error parsing Gemini response')
              exit(1)

          # 4. Post comment back to GitHub Issue
          gh_headers = {
              'Authorization': f'Bearer {gh_token}',
              'Accept': 'application/vnd.github.v3+json'
          }
          comment_url = f'https://api.github.com/repos/{repo}/issues/{issue_number}/comments'
          comment_data = {
              'body': f'### â™Š Gemini Action Plan\n\n{ai_checklist}'
          }
          
          print('Posting to GitHub...')
          gh_response = requests.post(comment_url, headers=gh_headers, json=comment_data)
          gh_response.raise_for_status()
          print('Done!')
          "
