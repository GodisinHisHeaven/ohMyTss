name: AI Issue Triage (Gemini)

on:
  issues:
    types: [opened]

permissions:
  issues: write

jobs:
  analyze_issue:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install dependencies
        run: pip install requests

      - name: Analyze Issue with Gemini Pro
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ISSUE_TITLE: ${{ github.event.issue.title }}
          ISSUE_BODY: ${{ github.event.issue.body }}
          REPO_FULL_NAME: ${{ github.repository }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
        run: |
          python -c "
          import os
          import requests
          import json

          # 1. Setup Data
          api_key = os.environ.get('GEMINI_API_KEY')
          issue_title = os.environ.get('ISSUE_TITLE')
          issue_body = os.environ.get('ISSUE_BODY')
          repo = os.environ.get('REPO_FULL_NAME')
          issue_number = os.environ.get('ISSUE_NUMBER')
          gh_token = os.environ.get('GITHUB_TOKEN')

          # 2. Construct the Gemini Payload
          # We use gemini-1.5-pro for better reasoning, but you can swap to gemini-1.5-flash for speed
          url = f'https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-pro:generateContent?key={api_key}'
          
          system_instruction = 'You are a senior technical project manager. Read the issue description and convert it into a clear, actionable Markdown checklist. Do not include introductory text, just the checklist.'
          user_content = f'Title: {issue_title}\n\nDescription:\n{issue_body}'

          payload = {
              'contents': [{
                  'parts': [{'text': system_instruction + '\n\n' + user_content}]
              }]
          }

          # 3. Call Google Gemini API
          headers = {'Content-Type': 'application/json'}
          
          print('Sending request to Gemini...')
          response = requests.post(url, headers=headers, json=payload)
          
          if response.status_code != 200:
              print(f'Error: {response.text}')
              exit(1)
              
          # Extract text from Gemini response structure
          result = response.json()
          try:
              ai_checklist = result['candidates'][0]['content']['parts'][0]['text']
          except (KeyError, IndexError):
              print('Error parsing Gemini response')
              exit(1)

          # 4. Post comment back to GitHub Issue
          gh_headers = {
              'Authorization': f'Bearer {gh_token}',
              'Accept': 'application/vnd.github.v3+json'
          }
          comment_url = f'https://api.github.com/repos/{repo}/issues/{issue_number}/comments'
          comment_data = {
              'body': f'### â™Š Gemini Action Plan\n\n{ai_checklist}'
          }
          
          print('Posting to GitHub...')
          gh_response = requests.post(comment_url, headers=gh_headers, json=comment_data)
          gh_response.raise_for_status()
          print('Done!')
          "
